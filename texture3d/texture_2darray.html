<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<script id="vs" type="x-shader/x-vertex">#version 300 es
in vec4 position;
out vec2 vCoord;
void main()
{
    vCoord = position.xy * 0.5 + 0.5;
    gl_Position = position;
}
</script>
<script id="fs" type="x-shader/x-fragment">#version 300 es
precision mediump float;
precision highp sampler3D;

in vec2 vCoord;
uniform sampler3D volume;
out vec4 fragColor;
void main() 
{
    vec4 color = texture3D(volume, vCoord);
    fragColor = color;
}
</script>
</head>
<body>
    <script>
        let canvas = document.createElement( 'canvas' )
        let gl = canvas.getContext( 'webgl2' )
        if( gl == null ) { alert( 'requires webgl2 support!' ) }
    
        let vs_source = document.getElementById('vs').textContent;
        let fs_source = document.getElementById('fs').textContent;
       
        let vs_shader = gl.createShader(gl.VERTEX_SHADER);
        gl.shaderSource(vs_shader, vs_source);
        gl.compileShader(vs_shader);
        let err_shader = gl.getShaderInfoLog(vs_shader);
        console.log(err_shader);
        let fs_shader = gl.createShader(gl.FRAGMENT_SHADER);
        gl.shaderSource(fs_shader, fs_source);
        gl.compileShader(fs_shader);
        err_shader = gl.getShaderInfoLog(fs_shader);
        console.log(err_shader);

        var program = gl.createProgram();
        gl.attachShader(program, vs_shader);
        gl.attachShader(program, fs_shader);
        gl.linkProgram(program);
        
        gl.useProgram(program);
        
        let uVolume = gl.getUniformLocation(program, 'volume');
    
        let s3tc  = gl.getExtension( 'WEBGL_compressed_texture_s3tc'  );
        let size = 64
        let data = new Uint8Array( size * size * size );
        data.forEach(function(element, index, array) {
            if (index+1 % 4 == 0) 
                array[index] = 255;
            else 
                array[index] = Math.floor(Math.random() * Math.floor(255));
        });
    
        let texture3D = gl.createTexture()
        let texture2DArray = gl.createTexture()
        gl.activeTexture(gl.TEXTURE0);
        gl.bindTexture( gl.texture2DArray, texture2DArray);
        gl.compressedTexImage3D(
            gl.TEXTURE_2D_ARRAY, // target
            0, // level
            s3tc.COMPRESSED_RGB_S3TC_DXT1_EXT
            , // internal format
            size, // width
            size, // height
            size, // depth
            0, // border
            data // data
        );
    
        gl.texParameteri(
            gl.TEXTURE_2D_ARRAY, 
            gl.TEXTURE_MAG_FILTER, gl.NEAREST
        );
        gl.texParameteri(
            gl.TEXTURE_2D_ARRAY,
            gl.TEXTURE_MIN_FILTER, gl.NEAREST
        );
        gl.texParameteri(
            gl.TEXTURE_2D_ARRAY,
            gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE
        );
        gl.texParameteri(
            gl.TEXTURE_2D_ARRAY,
            gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE
        );
        gl.texParameteri(
            gl.TEXTURE_2D_ARRAY,
            gl.TEXTURE_WRAP_R, gl.CLAMP_TO_EDGE
        );
        
        gl.uniform1i(uVolume, 0);

        // 顶点数据
        let vertices = new Float32Array([
            -1.0, 1.0,
            -1.0, -1.0,
            1.0, -1.0,
            1.0, 1.0
        ]);
        let vertexBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, vertexBuffer);
        gl.bufferData(gl.ARRAY_BUFFER, vertices, gl.STATIC_DRAW);
        
        let aPosition = gl.getAttribLocation(program, 'position');
        gl.vertexAttribPointer(aPosition, 2, gl.FLOAT, false, 0, 0);
        gl.enableVertexAttribArray(aPosition);

        // 绘制 
        gl.clearColor(0, 0, 0, 1);
        gl.clear(gl.COLOR_BUFFER_BIT);
        gl.drawArrays(gl.TRIANGLE_FAN, 0, 4);
    </script>        
</body>
</html>