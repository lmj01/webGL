<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<script id="vs" type="x-shader/x-vertex">
#version 300 es
precision highp float;

uniform mat4 umvp;
layout(location = 0) in vec3 Position;
layout(location = 1) in vec3 Colour;
out vec4 vColor;

void main()
{
    gl_Position = umvp * vec4(Position, 0.0);
    vColor = vec4(Colour, 1.0);
}
</script>
<script id="fs" type="x-shader/x-fragment">
#version 300 es
precision highp float;

in vec4 vColor;
out vec4 FragColor;
void main()
{
    FragColor = vColor;
}
</script>
<style>
    #demo {
        border: 1px solid red;
    }
</style>
</head>
<body>
    <canvas id="demo"></canvas>
    <script src="./perlin.js"></script>
    <script src="./gl-matrix.js"></script>
    <script>
        // http://prideout.net/blog/?p=64

        function getShaderSource(id) {
            return document.getElementById(id).textContent.replace(/^\s+|\s+$/g, '');
        }

        function createShader(gl, source, type) {
            var shader = gl.createShader(type);
            gl.shaderSource(shader, source);
            gl.compileShader(shader);
            var log = gl.getShaderInfoLog(shader);
            if (log) {
                console.log(log);
            }
            return shader;
        }

        function createProgram(gl, vs, fs) {
            var program = gl.createProgram();
            gl.attachShader(program, vs); gl.deleteShader(vs);
            gl.attachShader(program, fs); gl.deleteShader(fs);
            gl.linkProgram(program);
            var log = gl.getProgramInfoLog(program);
            if (log) {
                console.log('program',log);
            }
            return program;            
        }

        var ctxwidth = 600;// window.innerWidth;
        var ctxheight = 600; //window.innerHeight;
        let canvas = document.getElementById('demo');
        canvas.width = ctxwidth;
        canvas.height = ctxheight;
        canvas.setAttribute('width', ctxwidth);
        canvas.setAttribute('height', ctxheight);
        let gl = canvas.getContext( 'webgl2', { antialias: true } )
        if( gl == null ) { alert( 'requires webgl2 support!' ) }
    
        let vs = createShader(gl, getShaderSource('vs'), gl.VERTEX_SHADER);
        let fs = createShader(gl, getShaderSource('fs'), gl.FRAGMENT_SHADER);
        let program = createProgram(gl, vs, fs);

        var vertices = [
            -1,-1,-1, 1,-1,-1, 1, 1,-1, -1, 1,-1,
            -1,-1, 1, 1,-1, 1, 1, 1, 1, -1, 1, 1,
            -1,-1,-1, -1, 1,-1, -1, 1, 1, -1,-1, 1,
            1,-1,-1, 1, 1,-1, 1, 1, 1, 1,-1, 1,
            -1,-1,-1, -1,-1, 1, 1,-1, 1, 1,-1,-1,
            -1, 1,-1, -1, 1, 1, 1, 1, 1, 1, 1,-1, 
        ];

        var colors = [
            5,3,7, 5,3,7, 5,3,7, 5,3,7,
            1,1,3, 1,1,3, 1,1,3, 1,1,3,
            0,0,1, 0,0,1, 0,0,1, 0,0,1,
            1,0,0, 1,0,0, 1,0,0, 1,0,0,
            1,1,0, 1,1,0, 1,1,0, 1,1,0,
            0,1,0, 0,1,0, 0,1,0, 0,1,0
        ];

        var indices = [
            0,1,2, 0,2,3, 4,5,6, 4,6,7,
            8,9,10, 8,10,11, 12,13,14, 12,14,15,
            16,17,18, 16,18,19, 20,21,22, 20,22,23 
        ];

        // Create and store data into vertex buffer
        var vertex_buffer = gl.createBuffer ();
        gl.bindBuffer(gl.ARRAY_BUFFER, vertex_buffer);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW);

        // Create and store data into color buffer
        var color_buffer = gl.createBuffer ();
        gl.bindBuffer(gl.ARRAY_BUFFER, color_buffer);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(colors), gl.STATIC_DRAW);

        // Create and store data into index buffer
        var index_buffer = gl.createBuffer ();
        gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, index_buffer);
        gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Uint16Array(indices), gl.STATIC_DRAW);

        var FieldOfView = 0.78; // 45-degree
        var near = 1.0;
        var far = 1000.0;

        var rotate = quat.create();
        var degree = 0;
        function updateRotate(deg, axis) {
            var rad = deg * Math.PI / 180.0;
	        var rotation = quat.create();
	        quat.setAxisAngle(rotation, axis, rad);
	        quat.normalize(rotation, rotation);
	        quat.multiply(rotate, rotation, rotate);
        }
        function rotateX(deg) {
	        updateRotate(deg, [1,0,0]);
        }
        function rotateY(deg) {
	        updateRotate(deg, [0,1,0]);
        }
        function rotateZ(deg) {
	        updateRotate(deg, [0,0,1]);
        }

        var umvp = mat4.create();
        mat4.identity(umvp);
        var uproject = mat4.create();
        mat4.identity(uproject);
        var uview = mat4.create();
        mat4.identity(uview);
        var umv = mat4.create();
        mat4.identity(umv);
        var eye = vec3.fromValues(0, 0, 6);
        var center = vec3.fromValues(0, 0, 0);
        var up = vec3.fromValues(0, 1, 0);

        function get_project(angle, a, zmin, zmax) {
            var ang=  Math.tan((angle * 0.5)*Math.PI/180);
            return [
                0.5/ang, 0, 0, 0,
                0, 0.5*a/ang, 0, 0,
                0, 0, -(zmax+zmin)/(zmax-zmin), -1,
                0, 0, (-2*zmax*zmin)/(zmax-zmin), 0
            ];
        }
        function updateMatrix() {

            mat4.targetTo(uview, eye, center, up);
            
            var modelMatrix = mat4.create();
            mat4.identity(modelMatrix);

            // rotate model
            var rotmat = mat4.create();
            mat4.fromQuat(rotmat, rotate);
            mat4.multiply(modelMatrix, modelMatrix, rotmat);

            mat4.multiply(umv, uview, modelMatrix);

            mat4.perspective(uproject, FieldOfView, ctxwidth/ctxheight, near, far);
            //uproject = get_project(45.0, ctxwidth/ctxheight, near, far);
            mat4.multiply(umvp, uproject, umv);
        }
        gl.vertexAttribPointer(0, 3, gl.FLOAT, false, 0, 0);
                gl.enableVertexAttribArray(0);
                gl.vertexAttribPointer(1, 3, gl.FLOAT, false, 0, 0);
                gl.enableVertexAttribArray(1);
            gl.useProgram(program);

        var mvploc = gl.getUniformLocation(program, 'umvp');
        gl.uniformMatrix4fv(mvploc, false, umvp);
        
        function work_render() {   
                     
            gl.enable(gl.DEPTH_TEST);
            gl.depthFunc(gl.LEQUAL);

            gl.clearColor(0.2, 0.2, 0.2, 1.0);
            
            gl.viewport(0.0, 0.0, ctxwidth, ctxheight);
            
            gl.clear(
                gl.COLOR_BUFFER_BIT
                | gl.DEPTH_BUFFER_BIT
            );            

            
            updateMatrix();

            // set uniform
            gl.uniformMatrix4fv(mvploc, false, umvp);

            gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, index_buffer);            
            gl.drawElements(gl.TRIANGLES, indices.length, gl.UNSIGNED_SHORT, 0);

            degree++;
            rotateX(degree);
            rotateY(degree);
            rotateZ(degree);

            setTimeout( function(){
                requestAnimationFrame(work_render);
            }, 200);                   
        }
        work_render();
    
    </script>        
</body>
</html>